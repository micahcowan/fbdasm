# SEARCH STACK:
#   
#   I think GAME codes are stored at $D400 and on. In a data pointer table at $B00B
#     Something interesting at $D000, too. a game background map, probably?
#   Any other st* to NMICMD
#   WaitForNmiSubcommand
#   MarkWrappedLine
#   PrintString
#   QueueStringForOutput
#   QueueCharForOutput
#   QueueNullForOutput
#   Any remaining fns in CtrlCharInputHandlersTbl
#
#   ReadKeyboard

# BRANCH STACK:
#   DefaultNmiHandler
#   A more in-depth look at what ExprUnaryOrLiteral ($A490) does
#   DirectModeLoop
#  $8334 ExecuteDirectModeLineIThink
#  $97A6 second of two functions called when direct-mode line begins with number
#  $84E5 first of two functions called when direct-mode line begins with number
#   -> $904D
#     -> $8EF7
#   $853A
#    $857F
#
#  Write up what I know so far, and the bugs I've found

fn sub(a, b):
    if a == -32768:
        if b >= 0: # BUG. s/b: b > 0
            raise ErrorOverflow
        else:
            return add(a, -b)
    else:
        # a != -32768
        if (-a) < 0 || b < 0:
            return -( add(-a, b) )
        else:
            ret = -a + b
            if ret == -32768:
                return ret
            else if ret >= 0:
                return -ret
            else:
                raise ErrorOverflow

fn add(a, b):
    if a < 0:
        if b < 0:
            # neg plus neg
            ret = (-a) + (-b)
            if ret == -32768:
                return ret  # already negative 
            elif ret < 0:
                raise ErrorOverflow
            else:
                return -ret
        else:
            # neg plus pos
            return -( (-a) - b )
    else if b < 0:
        # pos plus neg
        return a - (-b)
    else:
        # pos plus pos
        ret = acc + parm;
        if ret < 0:
            raise ErrorOverflow
